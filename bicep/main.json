{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "16820560969040598920"
    }
  },
  "parameters": {
    "appName": {
      "type": "string",
      "defaultValue": "rentalrepairs",
      "minLength": 3,
      "maxLength": 20,
      "metadata": {
        "description": "Name of the application (used in resource naming)"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "Environment name (dev, staging, prod)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "canadacentral",
      "metadata": {
        "description": "Azure region for all resources"
      }
    },
    "appServiceSku": {
      "type": "string",
      "defaultValue": "B1",
      "allowedValues": [
        "F1",
        "B1",
        "B2",
        "S1",
        "P1v2"
      ],
      "metadata": {
        "description": "App Service Plan SKU"
      }
    },
    "sqlAdminUsername": {
      "type": "string",
      "defaultValue": "sqladmin",
      "metadata": {
        "description": "SQL Server admin username"
      }
    },
    "sqlAdminPassword": {
      "type": "securestring",
      "minLength": 12,
      "metadata": {
        "description": "SQL Server admin password"
      }
    },
    "sqlDatabaseSku": {
      "type": "string",
      "defaultValue": "GP_S_Gen5",
      "allowedValues": [
        "GP_S_Gen5",
        "Basic",
        "S0",
        "S1",
        "P1"
      ],
      "metadata": {
        "description": "SQL Database SKU name"
      }
    },
    "sqlAutoPauseDelay": {
      "type": "int",
      "defaultValue": 60,
      "metadata": {
        "description": "Auto-pause delay in minutes for serverless SQL (set to -1 to disable)"
      }
    },
    "sqlMinCapacity": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Minimum capacity (vCores) for serverless SQL"
      }
    },
    "sqlMaxCapacity": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "Maximum capacity (vCores) for serverless SQL"
      }
    },
    "sqlMaxSizeGb": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "Maximum database size in GB"
      }
    },
    "sqlAadAdminLogin": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Azure AD admin login email (optional)"
      }
    },
    "sqlAadAdminObjectId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Azure AD admin object ID (optional)"
      }
    },
    "allowAzureServices": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Allow Azure services to access SQL Server"
      }
    },
    "allowLocalIp": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Allow local IP address to access SQL Server"
      }
    },
    "localIpAddress": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Local IP address to whitelist (optional)"
      }
    },
    "appInsightsRetentionDays": {
      "type": "int",
      "defaultValue": 30,
      "minValue": 30,
      "maxValue": 730,
      "metadata": {
        "description": "Application Insights retention period in days"
      }
    },
    "keyVaultAdminObjectId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Object ID of the user/service principal for Key Vault admin access (leave empty to use current principal)"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Additional tags to apply to all resources"
      }
    }
  },
  "variables": {
    "commonTags": "[union(parameters('tags'), createObject('Environment', parameters('environment'), 'Application', parameters('appName'), 'ManagedBy', 'Bicep'))]",
    "resourceGroupName": "[format('{0}-{1}-rg', parameters('appName'), parameters('environment'))]"
  },
  "resources": {
    "resourceGroup": {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2023-07-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('commonTags')]"
    },
    "applicationInsights": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "applicationInsights-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "retentionInDays": {
            "value": "[parameters('appInsightsRetentionDays')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "7415182919171255324"
            }
          },
          "parameters": {
            "appName": {
              "type": "string",
              "metadata": {
                "description": "Name of the application"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "workspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Log Analytics Workspace ID (optional)"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 30,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "Retention period in days"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to resources"
              }
            }
          },
          "variables": {
            "appInsightsName": "[format('{0}-{1}-ai', parameters('appName'), parameters('environment'))]"
          },
          "resources": {
            "applicationInsights": {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[variables('appInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "RetentionInDays": "[parameters('retentionInDays')]",
                "WorkspaceResourceId": "[if(not(empty(parameters('workspaceId'))), parameters('workspaceId'), null())]",
                "IngestionMode": "[if(not(empty(parameters('workspaceId'))), 'LogAnalytics', 'ApplicationInsights')]",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            }
          },
          "outputs": {
            "applicationInsightsName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Application Insights"
              },
              "value": "[variables('appInsightsName')]"
            },
            "instrumentationKey": {
              "type": "securestring",
              "metadata": {
                "description": "The instrumentation key"
              },
              "value": "[reference('applicationInsights').InstrumentationKey]"
            },
            "connectionString": {
              "type": "securestring",
              "metadata": {
                "description": "The connection string"
              },
              "value": "[reference('applicationInsights').ConnectionString]"
            },
            "applicationId": {
              "type": "string",
              "metadata": {
                "description": "The Application ID"
              },
              "value": "[reference('applicationInsights').AppId]"
            },
            "applicationInsightsId": {
              "type": "string",
              "metadata": {
                "description": "The Application Insights ID"
              },
              "value": "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup"
      ]
    },
    "appServicePlan": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appServicePlan-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "[parameters('appServiceSku')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "6964845747072283295"
            }
          },
          "parameters": {
            "appName": {
              "type": "string",
              "metadata": {
                "description": "Name of the application"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "B1",
              "allowedValues": [
                "F1",
                "B1",
                "B2",
                "S1",
                "P1v2"
              ],
              "metadata": {
                "description": "App Service Plan SKU"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to resources"
              }
            }
          },
          "variables": {
            "appServicePlanName": "[format('{0}-{1}-asp', parameters('appName'), parameters('environment'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[variables('appServicePlanName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]",
                "tier": "[if(equals(parameters('sku'), 'F1'), 'Free', if(or(equals(parameters('sku'), 'B1'), equals(parameters('sku'), 'B2')), 'Basic', if(equals(parameters('sku'), 'S1'), 'Standard', 'PremiumV2')))]"
              },
              "kind": "windows",
              "properties": {
                "reserved": false
              }
            }
          ],
          "outputs": {
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "The ID of the App Service Plan"
              },
              "value": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
            },
            "appServicePlanName": {
              "type": "string",
              "metadata": {
                "description": "The name of the App Service Plan"
              },
              "value": "[variables('appServicePlanName')]"
            },
            "appServicePlanSku": {
              "type": "string",
              "metadata": {
                "description": "The SKU of the App Service Plan"
              },
              "value": "[reference(resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName')), '2023-01-01', 'full').sku.name]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup"
      ]
    },
    "sqlServer": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "sqlServer-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sqlAdminUsername": {
            "value": "[parameters('sqlAdminUsername')]"
          },
          "sqlAdminPassword": {
            "value": "[parameters('sqlAdminPassword')]"
          },
          "sqlAadAdminLogin": {
            "value": "[parameters('sqlAadAdminLogin')]"
          },
          "sqlAadAdminObjectId": {
            "value": "[parameters('sqlAadAdminObjectId')]"
          },
          "allowAzureServices": {
            "value": "[parameters('allowAzureServices')]"
          },
          "allowLocalIp": {
            "value": "[parameters('allowLocalIp')]"
          },
          "localIpAddress": {
            "value": "[parameters('localIpAddress')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "9526510939628616422"
            }
          },
          "parameters": {
            "appName": {
              "type": "string",
              "metadata": {
                "description": "Name of the application"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "sqlAdminUsername": {
              "type": "string",
              "metadata": {
                "description": "SQL Server admin username"
              }
            },
            "sqlAdminPassword": {
              "type": "securestring",
              "metadata": {
                "description": "SQL Server admin password"
              }
            },
            "sqlAadAdminLogin": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure AD admin login email (optional)"
              }
            },
            "sqlAadAdminObjectId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure AD admin object ID (optional)"
              }
            },
            "allowAzureServices": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Azure services to access this server"
              }
            },
            "allowLocalIp": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Allow local IP address (optional)"
              }
            },
            "localIpAddress": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Local IP address to whitelist (optional)"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to resources"
              }
            }
          },
          "variables": {
            "sqlServerName": "[format('{0}-{1}-sql', parameters('appName'), parameters('environment'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2023-05-01-preview",
              "name": "[variables('sqlServerName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "administratorLogin": "[parameters('sqlAdminUsername')]",
                "administratorLoginPassword": "[parameters('sqlAdminPassword')]",
                "version": "12.0",
                "minimalTlsVersion": "1.2",
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "condition": "[and(not(empty(parameters('sqlAadAdminLogin'))), not(empty(parameters('sqlAadAdminObjectId'))))]",
              "type": "Microsoft.Sql/servers/administrators",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerName'), 'ActiveDirectory')]",
              "properties": {
                "administratorType": "ActiveDirectory",
                "login": "[parameters('sqlAadAdminLogin')]",
                "sid": "[parameters('sqlAadAdminObjectId')]",
                "tenantId": "[subscription().tenantId]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
              ]
            },
            {
              "condition": "[parameters('allowAzureServices')]",
              "type": "Microsoft.Sql/servers/firewallRules",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerName'), 'AllowAzureServices')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "0.0.0.0"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
              ]
            },
            {
              "condition": "[and(parameters('allowLocalIp'), not(empty(parameters('localIpAddress'))))]",
              "type": "Microsoft.Sql/servers/firewallRules",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerName'), 'AllowLocalIP')]",
              "properties": {
                "startIpAddress": "[parameters('localIpAddress')]",
                "endIpAddress": "[parameters('localIpAddress')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
              ]
            }
          ],
          "outputs": {
            "sqlServerName": {
              "type": "string",
              "metadata": {
                "description": "The name of the SQL Server"
              },
              "value": "[variables('sqlServerName')]"
            },
            "sqlServerFqdn": {
              "type": "string",
              "metadata": {
                "description": "The fully qualified domain name of the SQL Server"
              },
              "value": "[reference(resourceId('Microsoft.Sql/servers', variables('sqlServerName')), '2023-05-01-preview').fullyQualifiedDomainName]"
            },
            "sqlServerId": {
              "type": "string",
              "metadata": {
                "description": "The SQL Server ID"
              },
              "value": "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup"
      ]
    },
    "sqlDatabase": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "sqlDatabase-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sqlServerName": {
            "value": "[reference('sqlServer').outputs.sqlServerName.value]"
          },
          "skuName": {
            "value": "[parameters('sqlDatabaseSku')]"
          },
          "autoPauseDelayInMinutes": {
            "value": "[parameters('sqlAutoPauseDelay')]"
          },
          "minCapacity": {
            "value": "[parameters('sqlMinCapacity')]"
          },
          "maxCapacity": {
            "value": "[parameters('sqlMaxCapacity')]"
          },
          "maxSizeGb": {
            "value": "[parameters('sqlMaxSizeGb')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1575915300934247990"
            }
          },
          "parameters": {
            "appName": {
              "type": "string",
              "metadata": {
                "description": "Name of the application"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "sqlServerName": {
              "type": "string",
              "metadata": {
                "description": "SQL Server name"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "GP_S_Gen5",
              "allowedValues": [
                "GP_S_Gen5",
                "Basic",
                "S0",
                "S1",
                "P1"
              ],
              "metadata": {
                "description": "SQL Database SKU name"
              }
            },
            "autoPauseDelayInMinutes": {
              "type": "int",
              "defaultValue": 60,
              "metadata": {
                "description": "Auto-pause delay in minutes for serverless (set to -1 to disable)"
              }
            },
            "minCapacity": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Minimum capacity (vCores) for serverless"
              }
            },
            "maxCapacity": {
              "type": "int",
              "defaultValue": 2,
              "metadata": {
                "description": "Maximum capacity (vCores) for serverless"
              }
            },
            "maxSizeGb": {
              "type": "int",
              "defaultValue": 2,
              "metadata": {
                "description": "Maximum size in GB"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to resources"
              }
            }
          },
          "variables": {
            "databaseName": "[format('{0}-{1}-db', parameters('appName'), parameters('environment'))]",
            "isServerless": "[equals(parameters('skuName'), 'GP_S_Gen5')]"
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', parameters('sqlServerName'), variables('databaseName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[if(variables('isServerless'), 'GeneralPurpose', if(equals(parameters('skuName'), 'Basic'), 'Basic', if(startsWith(parameters('skuName'), 'S'), 'Standard', 'Premium')))]",
                "capacity": "[if(variables('isServerless'), parameters('maxCapacity'), null())]"
              },
              "properties": {
                "collation": "SQL_Latin1_General_CP1_CI_AS",
                "maxSizeBytes": "[mul(mul(mul(parameters('maxSizeGb'), 1024), 1024), 1024)]",
                "catalogCollation": "SQL_Latin1_General_CP1_CI_AS",
                "zoneRedundant": false,
                "readScale": "Disabled",
                "requestedBackupStorageRedundancy": "Local",
                "autoPauseDelay": "[if(variables('isServerless'), parameters('autoPauseDelayInMinutes'), null())]",
                "minCapacity": "[if(variables('isServerless'), parameters('minCapacity'), null())]"
              }
            }
          ],
          "outputs": {
            "databaseName": {
              "type": "string",
              "metadata": {
                "description": "The name of the SQL Database"
              },
              "value": "[variables('databaseName')]"
            },
            "databaseId": {
              "type": "string",
              "metadata": {
                "description": "The SQL Database ID"
              },
              "value": "[resourceId('Microsoft.Sql/servers/databases', split(format('{0}/{1}', parameters('sqlServerName'), variables('databaseName')), '/')[0], split(format('{0}/{1}', parameters('sqlServerName'), variables('databaseName')), '/')[1])]"
            },
            "databaseSku": {
              "type": "string",
              "metadata": {
                "description": "The SKU of the database"
              },
              "value": "[reference(resourceId('Microsoft.Sql/servers/databases', split(format('{0}/{1}', parameters('sqlServerName'), variables('databaseName')), '/')[0], split(format('{0}/{1}', parameters('sqlServerName'), variables('databaseName')), '/')[1]), '2023-05-01-preview', 'full').sku.name]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup",
        "sqlServer"
      ]
    },
    "keyVault": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "keyVault-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tenantId": {
            "value": "[tenant().tenantId]"
          },
          "adminObjectId": "[if(not(empty(parameters('keyVaultAdminObjectId'))), createObject('value', parameters('keyVaultAdminObjectId')), createObject('value', subscription().subscriptionId))]",
          "webAppPrincipalId": {
            "value": ""
          },
          "sqlConnectionString": {
            "value": "[format('Server=tcp:{0},1433;Initial Catalog={1};Persist Security Info=False;User ID={2};Password={3};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;', reference('sqlServer').outputs.sqlServerFqdn.value, reference('sqlDatabase').outputs.databaseName.value, parameters('sqlAdminUsername'), parameters('sqlAdminPassword'))]"
          },
          "sqlAdminPassword": {
            "value": "[parameters('sqlAdminPassword')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "14988502424713918117"
            }
          },
          "parameters": {
            "appName": {
              "type": "string",
              "metadata": {
                "description": "Name of the application"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Tenant ID for Key Vault"
              }
            },
            "adminObjectId": {
              "type": "string",
              "metadata": {
                "description": "Object ID of the current user/service principal for admin access"
              }
            },
            "webAppPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Principal ID of the Web App managed identity"
              }
            },
            "sqlConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "SQL Connection String to store as secret"
              }
            },
            "sqlAdminPassword": {
              "type": "securestring",
              "metadata": {
                "description": "SQL Admin Password to store as secret"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to resources"
              }
            }
          },
          "variables": {
            "keyVaultName": "[format('{0}-{1}-kv', parameters('appName'), parameters('environment'))]"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[variables('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[parameters('tenantId')]",
                "enabledForDeployment": false,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 7,
                "enableRbacAuthorization": false,
                "accessPolicies": [
                  {
                    "tenantId": "[parameters('tenantId')]",
                    "objectId": "[parameters('adminObjectId')]",
                    "permissions": {
                      "secrets": [
                        "get",
                        "list",
                        "set",
                        "delete",
                        "recover",
                        "backup",
                        "restore"
                      ]
                    }
                  }
                ]
              }
            },
            {
              "condition": "[not(empty(parameters('webAppPrincipalId')))]",
              "type": "Microsoft.KeyVault/vaults/accessPolicies",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', variables('keyVaultName'), 'add')]",
              "properties": {
                "accessPolicies": [
                  {
                    "tenantId": "[parameters('tenantId')]",
                    "objectId": "[parameters('webAppPrincipalId')]",
                    "permissions": {
                      "secrets": [
                        "get",
                        "list"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', variables('keyVaultName'), 'SqlConnectionString')]",
              "properties": {
                "value": "[parameters('sqlConnectionString')]",
                "contentType": "text/plain"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', variables('keyVaultName'), 'SqlAdminPassword')]",
              "properties": {
                "value": "[parameters('sqlAdminPassword')]",
                "contentType": "text/plain"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Key Vault"
              },
              "value": "[variables('keyVaultName')]"
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "The URI of the Key Vault"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri]"
            },
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "The Key Vault ID"
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
            },
            "sqlConnectionStringSecretUri": {
              "type": "string",
              "metadata": {
                "description": "The SQL Connection String secret URI"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', variables('keyVaultName'), 'SqlConnectionString'), '2023-07-01').secretUri]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup",
        "sqlDatabase",
        "sqlServer"
      ]
    },
    "webApp": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "webApp-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appName": {
            "value": "[parameters('appName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "appServicePlanId": {
            "value": "[reference('appServicePlan').outputs.appServicePlanId.value]"
          },
          "applicationInsightsConnectionString": {
            "value": "[listOutputsWithSecureValues('applicationInsights', '2025-04-01').connectionString]"
          },
          "applicationInsightsInstrumentationKey": {
            "value": "[listOutputsWithSecureValues('applicationInsights', '2025-04-01').instrumentationKey]"
          },
          "keyVaultUri": {
            "value": "[reference('keyVault').outputs.keyVaultUri.value]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "544967213799692096"
            }
          },
          "parameters": {
            "appName": {
              "type": "string",
              "metadata": {
                "description": "Name of the application"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "appServicePlanId": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan ID"
              }
            },
            "applicationInsightsConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Application Insights Connection String"
              }
            },
            "applicationInsightsInstrumentationKey": {
              "type": "securestring",
              "metadata": {
                "description": "Application Insights Instrumentation Key"
              }
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "Key Vault URI for secret references"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to resources"
              }
            }
          },
          "variables": {
            "webAppName": "[format('{0}-{1}-app', parameters('appName'), parameters('environment'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[variables('webAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "app",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "siteConfig": {
                  "netFrameworkVersion": "v8.0",
                  "metadata": [
                    {
                      "name": "CURRENT_STACK",
                      "value": "dotnet"
                    }
                  ],
                  "alwaysOn": false,
                  "http20Enabled": true,
                  "minTlsVersion": "1.2",
                  "healthCheckPath": "/health",
                  "detailedErrorLoggingEnabled": true,
                  "httpLoggingEnabled": true,
                  "requestTracingEnabled": true,
                  "appSettings": [
                    {
                      "name": "ASPNETCORE_ENVIRONMENT",
                      "value": "Development"
                    },
                    {
                      "name": "WEBSITE_RUN_FROM_PACKAGE",
                      "value": "1"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[parameters('applicationInsightsConnectionString')]"
                    },
                    {
                      "name": "ApplicationInsightsAgent_EXTENSION_VERSION",
                      "value": "~3"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[parameters('applicationInsightsInstrumentationKey')]"
                    },
                    {
                      "name": "Logging__LogLevel__Default",
                      "value": "Information"
                    },
                    {
                      "name": "Logging__LogLevel__Microsoft.AspNetCore",
                      "value": "Warning"
                    },
                    {
                      "name": "Infrastructure__Performance__EnableCaching",
                      "value": "true"
                    },
                    {
                      "name": "Infrastructure__Email__Provider",
                      "value": "Mock"
                    },
                    {
                      "name": "DemoAuthentication__EnableDemoMode",
                      "value": "true"
                    },
                    {
                      "name": "Seeding__EnableSeeding",
                      "value": "true"
                    },
                    {
                      "name": "ConnectionStrings__DefaultConnection",
                      "value": "[format('@Microsoft.KeyVault(SecretUri={0}secrets/SqlConnectionString/)', parameters('keyVaultUri'))]"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('webAppName'), 'logs')]",
              "properties": {
                "applicationLogs": {
                  "fileSystem": {
                    "level": "Information"
                  }
                },
                "httpLogs": {
                  "fileSystem": {
                    "enabled": true,
                    "retentionInMb": 35,
                    "retentionInDays": 7
                  }
                },
                "detailedErrorMessages": {
                  "enabled": true
                },
                "failedRequestsTracing": {
                  "enabled": true
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('webAppName'))]"
              ]
            }
          ],
          "outputs": {
            "webAppName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Web App"
              },
              "value": "[variables('webAppName')]"
            },
            "webAppUrl": {
              "type": "string",
              "metadata": {
                "description": "The default hostname of the Web App"
              },
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', variables('webAppName')), '2023-01-01').defaultHostName)]"
            },
            "webAppPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the Web App managed identity"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', variables('webAppName')), '2023-01-01', 'full').identity.principalId]"
            },
            "webAppId": {
              "type": "string",
              "metadata": {
                "description": "The Web App ID"
              },
              "value": "[resourceId('Microsoft.Web/sites', variables('webAppName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "applicationInsights",
        "appServicePlan",
        "keyVault",
        "resourceGroup"
      ]
    }
  },
  "outputs": {
    "deploymentSummary": {
      "type": "object",
      "metadata": {
        "description": "Summary of the deployment"
      },
      "value": {
        "resourceGroup": "[variables('resourceGroupName')]",
        "location": "[parameters('location')]",
        "environment": "[parameters('environment')]",
        "webAppUrl": "[reference('webApp').outputs.webAppUrl.value]",
        "sqlServerFqdn": "[reference('sqlServer').outputs.sqlServerFqdn.value]",
        "databaseName": "[reference('sqlDatabase').outputs.databaseName.value]",
        "keyVaultName": "[reference('keyVault').outputs.keyVaultName.value]"
      }
    },
    "webAppUrl": {
      "type": "string",
      "metadata": {
        "description": "The URL of the deployed Web App"
      },
      "value": "[reference('webApp').outputs.webAppUrl.value]"
    },
    "webAppName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Web App"
      },
      "value": "[reference('webApp').outputs.webAppName.value]"
    },
    "webAppPrincipalId": {
      "type": "string",
      "metadata": {
        "description": "The principal ID of the Web App managed identity"
      },
      "value": "[reference('webApp').outputs.webAppPrincipalId.value]"
    },
    "sqlServerFqdn": {
      "type": "string",
      "metadata": {
        "description": "The fully qualified domain name of the SQL Server"
      },
      "value": "[reference('sqlServer').outputs.sqlServerFqdn.value]"
    },
    "sqlDatabaseName": {
      "type": "string",
      "metadata": {
        "description": "The name of the SQL Database"
      },
      "value": "[reference('sqlDatabase').outputs.databaseName.value]"
    },
    "sqlAdminUsername": {
      "type": "string",
      "metadata": {
        "description": "The SQL admin username"
      },
      "value": "[parameters('sqlAdminUsername')]"
    },
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Key Vault"
      },
      "value": "[reference('keyVault').outputs.keyVaultName.value]"
    },
    "keyVaultUri": {
      "type": "string",
      "metadata": {
        "description": "The URI of the Key Vault"
      },
      "value": "[reference('keyVault').outputs.keyVaultUri.value]"
    },
    "applicationInsightsInstrumentationKey": {
      "type": "securestring",
      "metadata": {
        "description": "The Application Insights Instrumentation Key"
      },
      "value": "[listOutputsWithSecureValues('applicationInsights', '2025-04-01').instrumentationKey]"
    },
    "applicationInsightsConnectionString": {
      "type": "securestring",
      "metadata": {
        "description": "The Application Insights Connection String"
      },
      "value": "[listOutputsWithSecureValues('applicationInsights', '2025-04-01').connectionString]"
    },
    "applicationInsightsAppId": {
      "type": "string",
      "metadata": {
        "description": "The Application Insights Application ID"
      },
      "value": "[reference('applicationInsights').outputs.applicationId.value]"
    },
    "nextSteps": {
      "type": "array",
      "metadata": {
        "description": "Next steps after deployment"
      },
      "value": [
        "1. Grant Key Vault access to Web App managed identity (see deployment guide)",
        "2. Deploy your application code to the Web App",
        "3. Run database migrations",
        "[format('4. Verify the application at {0}', reference('webApp').outputs.webAppUrl.value)]"
      ]
    }
  }
}